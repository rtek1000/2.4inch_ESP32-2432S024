!function(){"use strict";var t=function(){return t=Object.assign||function(t){for(var i,n=1,e=arguments.length;n<e;n++)for(var s in i=arguments[n])Object.prototype.hasOwnProperty.call(i,s)&&(t[s]=i[s]);return t},t.apply(this,arguments)};function i(t,i,n,e){return new(n||(n=Promise))((function(s,r){function o(t){try{a(e.next(t))}catch(t){r(t)}}function u(t){try{a(e.throw(t))}catch(t){r(t)}}function a(t){var i;t.done?s(t.value):(i=t.value,i instanceof n?i:new n((function(t){t(i)}))).then(o,u)}a((e=e.apply(t,i||[])).next())}))}function n(t,i){var n,e,s,r={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=u(0),o.throw=u(1),o.return=u(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(u){return function(a){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,u[0]&&(r=0)),r;)try{if(n=1,e&&(s=2&u[0]?e.return:u[0]?e.throw||((s=e.return)&&s.call(e),0):e.next)&&!(s=s.call(e,u[1])).done)return s;switch(e=0,s&&(u=[2&u[0],s.value]),u[0]){case 0:case 1:s=u;break;case 4:return r.label++,{value:u[1],done:!1};case 5:r.label++,e=u[1],u=[0];continue;case 7:u=r.ops.pop(),r.trys.pop();continue;default:if(!(s=r.trys,(s=s.length>0&&s[s.length-1])||6!==u[0]&&2!==u[0])){r=0;continue}if(3===u[0]&&(!s||u[1]>s[0]&&u[1]<s[3])){r.label=u[1];break}if(6===u[0]&&r.label<s[1]){r.label=s[1],s=u;break}if(s&&r.label<s[2]){r.label=s[2],r.ops.push(u);break}s[2]&&r.ops.pop(),r.trys.pop();continue}u=i.call(t,r)}catch(t){u=[6,t],e=0}finally{n=s=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}}function e(t){var i="function"==typeof Symbol&&Symbol.iterator,n=i&&t[i],e=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&e>=t.length&&(t=void 0),{value:t&&t[e++],done:!t}}};throw new TypeError(i?"Object is not iterable.":"Symbol.iterator is not defined.")}function s(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i,n=t[Symbol.asyncIterator];return n?n.call(t):(t=e(t),i={},s("next"),s("throw"),s("return"),i[Symbol.asyncIterator]=function(){return this},i);function s(n){i[n]=t[n]&&function(i){return new Promise((function(e,s){(function(t,i,n,e){Promise.resolve(e).then((function(i){t({value:i,done:n})}),i)})(e,s,(i=t[n](i)).done,i.value)}))}}}function r(t){t.setAttribute("style","height:auto"),t.setAttribute("style","height:".concat(t.scrollHeight,"px"))}function o(t,i){switch(i){case"HHmm":return t.toLocaleTimeString([],{hour:"numeric",minute:"numeric"}).replace(/\/g/,"-");case"MMDD":return t.toLocaleTimeString([],{month:"numeric",day:"numeric"}).replace(/\/g/,"-").split(" ")[0];case"YYYMMDD":return t.toLocaleTimeString("zh",{year:"numeric",month:"numeric",day:"numeric"}).replace(/\/g/,"-").split(" ")[0];case"dddd":return t.toLocaleTimeString("en-US",{weekday:"long"}).split(" ")[0]}}function u(t){return new Promise((function(i,n){var e=new FileReader;e.onload=function(){return i(e.result)},e.onerror=function(t){return n(t)},e.readAsDataURL(t)}))}function a(t){return i(this,void 0,void 0,(function(){var i,e,s,r,o;return n(this,(function(n){switch(n.label){case 0:return t instanceof File?[4,t.arrayBuffer()]:[3,2];case 1:return e=n.sent(),i=new Uint8Array(e),[3,3];case 2:s=new TextEncoder,i=s.encode(t),n.label=3;case 3:return[4,crypto.subtle.digest("SHA-256",i)];case 4:return r=n.sent(),o=Array.from(new Uint8Array(r)),[2,o.map((function(t){return t.toString(16).padStart(2,"0")})).join("")]}}))}))}function c(t,i){return(i||document).querySelector(t)}function h(t){return document.createElement(t)}function f(t,i,n,e){(n||document).addEventListener(t,i,e)}function d(t,i,n,e){(n||document).removeEventListener(t,i,e)}function v(t,i){t.appendChild(i)}function l(){return"E".concat(crypto.randomUUID())}"function"==typeof SuppressedError&&SuppressedError;var m,E,w,p=function(){var t=navigator.userAgent||navigator.vendor||window.opera;return/iPad|Macintosh/i.test(t)&&navigator.maxTouchPoints&&navigator.maxTouchPoints>1?"iPad":/android/i.test(t)?"Android":/windows phone/i.test(t)?"Windows Phone":/win/i.test(t)?"Windows":/mac/i.test(t)?"MacOS":/linux/i.test(t)?"Linux":"Unknown"},g=function(){var t,i=navigator.userAgent||navigator.vendor||window.opera,n=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(i),e=/chrome|crios/i.test(i),s=/micromessenger/i.test(i);return{osName:p(),bsName:/chrome|crios/i.test(i)?"Chrome":/firefox|fxios/i.test(i)?"Firefox":/safari/i.test(i)&&!/chrome|crios/i.test(i)?"Safari":/msie|trident/i.test(i)?"Internet Explorer":/edge|edgios|edga/i.test(i)?"Edge":/opera|opr/i.test(i)?"Opera":"Unknown",bsVersion:(t=i.match(/(chrome|crios|firefox|fxios|safari|msie|trident|edge|edgios|edga|opera|opr)\/?\s*(\d+)/i),t&&t.length>2?t[2]:"Unknown"),isMobile:n,isPad:"iPad"===p(),isAndroid:"android"===p().toLocaleLowerCase(),isChrome:e,isWeChat:s}},S=Symbol("channel-closed"),b=function(){function t(){this.pushBuffer=[],this.popBuffer=[],this.closed=!1,this.maxBufferSize=100}return t.prototype.isClosed=function(){return this.closed},t.prototype.push=function(t){return i(this,void 0,void 0,(function(){var i=this;return n(this,(function(n){switch(n.label){case 0:if(this.closed)throw new Error("This channel has been closed!");return this.popBuffer.length>0?[2,new Promise((function(n){i.popBuffer.shift()({value:t,done:!1}),n()}))]:[3,1];case 1:return this.pushBuffer.length>=this.maxBufferSize?[4,new Promise((function(t){return setTimeout(t,100)}))]:[3,3];case 2:n.sent(),n.label=3;case 3:return[2,new Promise((function(n){i.pushBuffer.push({resolve:n,value:t})}))]}}))}))},t.prototype.pop=function(){return i(this,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,this.next()];case 1:return[2,t.sent().value]}}))}))},t.prototype.close=function(){var t=this;return new Promise((function(i){for(var n=0,e=t.pushBuffer;n<e.length;n++){var s=e[n],r=s.resolve;s.value,r()}t.pushBuffer=[];for(var o=0,u=t.popBuffer;o<u.length;o++){(0,u[o])({value:S,done:!0})}t.popBuffer=[],t.closed=!0,i()}))},t.prototype[Symbol.asyncIterator]=function(){return this},t.prototype.next=function(){var t=this;return this.closed?Promise.resolve({value:S,done:!0}):this.pushBuffer.length>0?new Promise((function(i){var n=t.pushBuffer.shift(),e=n.resolve,s=n.value;e(),i({value:s,done:!1})})):new Promise((function(i){t.popBuffer.push(i)}))},t}(),y=new b,T=new b,M=new b,O=new b,_=new b,D=new b,N=new b,k=new b,I=function(){function t(t){this.toastElement=t,this.listenToastChan()}return t.prototype.listenToastChan=function(){return i(this,void 0,void 0,(function(){var t,i,e,r,o,u,a,c,h;return n(this,(function(n){switch(n.label){case 0:n.trys.push([0,5,6,11]),t=!0,i=s(D),n.label=1;case 1:return[4,i.next()];case 2:if(e=n.sent(),u=e.done)return[3,4];h=e.value,t=!1,"error"==(r=h).level&&r.text&&this.error(r.text),n.label=3;case 3:return t=!0,[3,1];case 4:return[3,11];case 5:return o=n.sent(),a={error:o},[3,11];case 6:return n.trys.push([6,,9,10]),t||u||!(c=i.return)?[3,8]:[4,c.call(i)];case 7:n.sent(),n.label=8;case 8:return[3,10];case 9:if(a)throw a.error;return[7];case 10:return[7];case 11:return[2]}}))}))},t.prototype.show=function(t,i,n){if(void 0===n&&(n=5e3),this.toastElement){var e=h("li"),s=l();e.classList.add("-E-toast-item"),e.id=s,i&&v(e,i);var r=h("span");r.textContent=t,v(e,r),v(this.toastElement,e),setTimeout((function(){var t;null===(t=c("#".concat(s)))||void 0===t||t.classList.add("-E-h")}),n),setTimeout((function(){var t;null===(t=c("#".concat(s)))||void 0===t||t.remove()}),n+300)}},t.prototype.error=function(t,i){void 0===i&&(i=5e3);var n=h("div");n.classList="-E-error",this.show(t,n,i)},t}(),x=["","","","","","","","","User does not exist","","","","","Wrong password","","","","","","","Conversation blocked","","","","","","","","",""],A=function(){function t(t,i){this.messageQueue=[],this.isSending=!1,this.needsReconnect=!0,this.config=t,this.controller=i}return t.prototype.close=function(){this.needsReconnect=!1,this.resetFaildCount(),this.ws.readyState!=WebSocket.CLOSED&&this.ws.close()},t.prototype.connect=function(){this.ws&&this.ws.readyState==WebSocket.OPEN?this.wsReadyChan.push(!0):(this.reconnectTimeoutId&&(clearTimeout(this.reconnectTimeoutId),this.reconnectTimeoutId=void 0),this.resetFaildCount(),this.initWS())},t.prototype.sendMessage=function(t){this.messageQueue.push(t),this.isSending||this.sendMessages()},t.prototype.send=function(t){this.ws.send(t)},t.prototype.sendMessages=function(){var t=this;if(this.ws&&this.ws.readyState===WebSocket.OPEN&&this.messageQueue.length>0&&this.controller.userId){this.isSending=!0;var i=this.messageQueue.shift();this.ws.send(i),setTimeout((function(){t.isSending=!1,t.sendMessages()}),100)}},t.prototype.resetFaildCount=function(){this.faildCount=0},t.prototype.initWS=function(){var t=this;window.WebSocket?(this.startTime=(new Date).getTime(),this.ws=new WebSocket(this.config.url),this.wsReadyChan&&this.wsReadyChan.close(),this.wsReadyChan=new b,this.ws.onopen=function(){console.log(" Connect time: ",(new Date).getTime()-t.startTime,"ms"),t.resetFaildCount(),y.push({status:"success"}),t.wsReadyChan.push(!0)},this.ws.onerror=function(){t.ws.close()},this.ws.onmessage=function(t){M.push(t.data),window.postMessage({type:"IM/WS",data:t.data},window.location.origin)},this.ws.onclose=function(){if(y.push({status:"onClose"}),t.needsReconnect)return++t.faildCount>2?(y.push({status:"fail",reason:"The network is disconnected, please refresh this page and try again."}),t.wsReadyChan.push(!1),void window.postMessage({type:"IM/WS",data:{pb_msg:{status:"error"}}},window.location.origin)):void(t.reconnectTimeoutId=setTimeout((function(){t.initWS()}),1e3))}):y.push({status:"fail",reason:"The browser does not support WebSocket"})},t}();!function(t){t[t.USER=1]="USER",t[t.BUDDY=2]="BUDDY",t[t.MESSAGE=3]="MESSAGE",t[t.OTHER=7]="OTHER"}(m||(m={})),function(t){t[t.LOGIN=259]="LOGIN",t[t.HEARTBEAT=1793]="HEARTBEAT",t[t.MESSAGE=769]="MESSAGE",t[t.LATESTMSGID=779]="LATESTMSGID",t[t.HISTORYMSG=777]="HISTORYMSG"}(E||(E={})),function(t){t[t.LOGIN=260]="LOGIN",t[t.HEARTBEAT=1793]="HEARTBEAT",t[t.USERSTATNOTIFY=515]="USERSTATNOTIFY",t[t.MESSAGESENTSTATUS=770]="MESSAGESENTSTATUS",t[t.MESSAGE=769]="MESSAGE",t[t.MARKSESSION=558]="MARKSESSION",t[t.GETLATESTMSGID=780]="GETLATESTMSGID",t[t.GETHISTORYMSG=778]="GETHISTORYMSG",t[t.CHANGEKEFU=572]="CHANGEKEFU"}(w||(w={}));var P,J=function(){function e(t){var i,n,e,s;this.seq=0,this.messageMap=new Map,this.disConnectTime=6e5,this.isFirstLogin=!0,this.firstAiEffect=!0,this.firstSendEffect=!0,this.sessionInfo=null,this.messageCount=40,this.ResponseMap=((i={})[m.USER]=((n={})[w.LOGIN]=this.loginResponse,n),i[m.MESSAGE]=((e={})[w.MESSAGESENTSTATUS]=this.messageSentStatus,e[w.MESSAGE]=this.messageRes,e[w.GETLATESTMSGID]=this.getLatestMsgIdRes,e[w.GETHISTORYMSG]=this.getHistoryMsgRes,e),i[m.BUDDY]=((s={})[w.MARKSESSION]=this.markSessionRes,s[w.CHANGEKEFU]=this.changeKefuRes,s),i),this.config=t,this.ws=new A(this.config.wsConfig,this),this.listenOnMessage(),this.listenWS()}return e.prototype.updateConfig=function(t){var i=t.pid,n=t.extraInfo,e=t.cid;null!=i&&(this.config.pid=i),null!=e&&(this.config.cid=e),n&&(this.config.extraInfo=n)},e.prototype.sendMessage=function(e,s,r){return i(this,void 0,void 0,(function(){var i,o,u,a,c,h,f,d;return n(this,(function(n){switch(n.label){case 0:return[4,this.checkWS(s)];case 1:return n.sent(),this.userId&&this.config.sessionId?(i={},o=this.prepareCommonParams(m.OTHER,E.HEARTBEAT),s&&(o=this.prepareCommonParams(m.MESSAGE,E.MESSAGE),this.messageMap.set(o.seq,{uuid:s,type:r,message:e}),u=JSON.parse(this.config.extraInfo||"{}"),a="; ".concat(document.cookie),2===(c=a.split("; utm_source=")).length&&(h=null===(d=c.pop())||void 0===d?void 0:d.split(";").shift(),u.utm_source=h),i={from_user_id:this.userId,to_session_id:this.config.sessionId,msg_id:0,create_time:Math.floor((new Date).getTime()/1e3),msg_type:r||1,msg_data:e,extra_info:JSON.stringify(u),cid:+this.config.cid,pid:+this.config.pid}),f=t({pb_msg:i},o),console.log("sendMessage",f),this.ws.sendMessage(JSON.stringify(f)),s&&this.setDisconnect(),[2]):[2]}}))}))},e.prototype.connect=function(){return i(this,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,this.checkWS()];case 1:return t.sent(),[2]}}))}))},e.prototype.checkWS=function(t){return i(this,void 0,void 0,(function(){var i,e;return n(this,(function(n){switch(n.label){case 0:return this.ws.connect(),[4,this.ws.wsReadyChan.pop()];case 1:return(i=n.sent())==S?[2]:i?this.userId?[3,3]:(this.login(),[4,T.pop()]):(t&&O.push({status:"fail",uuid:t}),[2]);case 2:if((e=n.sent())==S)return[2];if("fail"==e.status)return t&&O.push({status:"fail",uuid:t}),D.push({level:"error",text:e.reason}),[2];n.label=3;case 3:return[2]}}))}))},e.prototype.listenWS=function(){return i(this,void 0,void 0,(function(){var t,i,e,r,o,u,a,c,h;return n(this,(function(n){switch(n.label){case 0:n.trys.push([0,5,6,11]),t=!0,i=s(y),n.label=1;case 1:return[4,i.next()];case 2:if(e=n.sent(),u=e.done)return[3,4];if(h=e.value,t=!1,"fail"==(r=h).status)return D.push({level:"error",text:r.reason}),[2];"onClose"==r.status&&(this.userId=null),n.label=3;case 3:return t=!0,[3,1];case 4:return[3,11];case 5:return o=n.sent(),a={error:o},[3,11];case 6:return n.trys.push([6,,9,10]),t||u||!(c=i.return)?[3,8]:[4,c.call(i)];case 7:n.sent(),n.label=8;case 8:return[3,10];case 9:if(a)throw a.error;return[7];case 10:return[7];case 11:return[2]}}))}))},e.prototype.login=function(){return i(this,void 0,void 0,(function(){var i,e;return n(this,(function(n){switch(n.label){case 0:return[4,a("ECER_CHBA_1526887294".concat(this.config.loginName))];case 1:return i=n.sent(),e=g(),this.ws.send(JSON.stringify(t({pb_msg:{user_name:this.config.loginName,password:i,online_status:1,client_type:3,client_version:"windows",cid:+this.config.cid,client_info:JSON.stringify({os:e.osName,browser:e.bsName,browser_version:e.bsVersion,isMobile:e.isMobile})}},this.prepareCommonParams(m.USER,E.LOGIN)))),this.isFirstLogin&&this.setDisconnect(),[2]}}))}))},e.prototype.prepareCommonParams=function(t,i){return{app_id:this.config.appId,sid:t,cid:i,seq:this.seq++}},e.prototype.setDisconnect=function(t){var i=this;console.debug((new Date).toLocaleTimeString(),"setDisconnect",t),this.disConnectTimeoutId&&(clearTimeout(this.disConnectTimeoutId),this.disConnectTimeoutId=void 0),t||(this.disConnectTimeoutId=setTimeout((function(){console.debug((new Date).toLocaleTimeString(),"called setDisconnect"),i.userId=null,i.stopHeartBeat()}),this.disConnectTime))},e.prototype.listenOnMessage=function(){return i(this,void 0,void 0,(function(){var t,i,e,r,o,u,a,c,h,f,d,v,l,E,p;return n(this,(function(n){switch(n.label){case 0:n.trys.push([0,5,6,11]),t=!0,i=s(M),n.label=1;case 1:return[4,i.next()];case 2:if(e=n.sent(),d=e.done)return[3,4];E=e.value,t=!1,r=E,o=void 0;try{o=JSON.parse(r)}catch(t){console.error("not json","on message",r)}u=o.sid,a=o.cid,c=o.pb_msg,u==m.MESSAGE&&a==w.MESSAGE&&this.setDisconnect(),u==m.USER&&a==w.LOGIN&&this.isFirstLogin&&this.setDisconnect(),c&&c.result_code&&0!=c.result_code&&D.push({level:"error",text:x[c.result_code]||""}),(h=null===(p=this.ResponseMap[u])||void 0===p?void 0:p[a])&&h.call(this,o),n.label=3;case 3:return t=!0,[3,1];case 4:return[3,11];case 5:return f=n.sent(),v={error:f},[3,11];case 6:return n.trys.push([6,,9,10]),t||d||!(l=i.return)?[3,8]:[4,l.call(i)];case 7:n.sent(),n.label=8;case 8:return[3,10];case 9:if(v)throw v.error;return[7];case 10:return[7];case 11:return[2]}}))}))},e.prototype.startHeartBeat=function(){var t=this;this.heartBeatIntervalId&&(clearInterval(this.heartBeatIntervalId),this.heartBeatIntervalId=void 0),this.heartBeatIntervalId=setInterval((function(){t.sendMessage("{}")}),2e4)},e.prototype.stopHeartBeat=function(){this.heartBeatIntervalId&&clearInterval(this.heartBeatIntervalId),this.ws.close()},e.prototype.loginResponse=function(t){var i=t.pb_msg;if(i){var n=i.result_code,e=i.user_info;if(0!=n)return this.stopHeartBeat(),void T.push({status:"fail",reason:"Login Failed"});if(!e||!e.user_id)return this.stopHeartBeat(),void T.push({status:"fail",reason:"Login Failed"});this.userId=e.user_id,this.isFirstLogin=!1,this.startHeartBeat(),T.push({status:"success"}),this.updateHistory()}},e.prototype.messageSentStatus=function(t){var i=t.seq,n=t.pb_msg;if(null!=i&&n){var e=n.session_id,s=n.session_type,r=n.user_id,o=n.result_code,u=n.msg_id;if(e==this.config.sessionId&&1==s&&r==this.userId){var a=this.messageMap.get(i);a&&(4!=a.type?(0==o?O.push({status:"success",uuid:a.uuid,messageId:u,message:a.message}):O.push({status:"fail",uuid:a.uuid}),a&&this.messageMap.delete(i)):a&&this.messageMap.delete(i))}}},e.prototype.messageRes=function(t){var i=t.seq,n=t.pb_msg;if(null!=i&&n){var e=n.from_user_id,s=n.msg_type,r=n.to_session_id,o=n.result_code,u=n.create_time,a=n.msg_data,c=n.msg_id;e!=this.config.sessionId||r!=this.userId||s>8||0==o&&_.push({time:u,message:a,messageId:c})}},e.prototype.markSessionRes=function(t){console.log("IM --- 558",t);var i=t.pb_msg;if(i){var n=i.result_code,e=i.status,s=i.type,r=i.land_id,o=i.session_id,u=i.user_id,a=i.cid,c=i.pid,h=i.buyer_nick,f=i.product_name,d=i.ext;if(0==n){if(0==e&&o==this.userId&&u!=this.config.sessionId&&this.updateSessionId(u),0==e&&this.firstAiEffect&&(null==f?void 0:f.toString().trim())){this.firstAiEffect=!1;var v={cid:a,pid:c,nick:h,keyword:f,buyerid:o,sellerid:u};this.sessionInfo=v;var l=0;try{l=JSON.parse(d).is_new_distribute}catch(t){}this.handleClickHideSessionEffect(l),window.postMessage({action:"onAiEffect",data:v},"*")}1==s&&r&&window.postMessage({action:"onLandPage",data:{buyerid:o,sellerid:u,landid:r}},"*")}}},e.prototype.handleClickHideSessionEffect=function(i){var n=c("-E-im"),e=null==n?void 0:n.classList.contains("-E-h");this.sessionInfo&&this.firstSendEffect&&(e||i)&&(this.firstSendEffect=!1,window.postMessage({action:"sessionEffect",data:t({},this.sessionInfo)},"*"))},e.prototype.updateHistory=function(){this.userId&&this.ws.sendMessage(JSON.stringify(t({pb_msg:{user_id:this.userId,session_type:1,session_id:this.config.sessionId}},this.prepareCommonParams(m.MESSAGE,E.LATESTMSGID))))},e.prototype.getLatestMsgIdRes=function(i){var n=i.pb_msg;if(n){var e=n.latest_msg_id,s=n.session_id,r=n.user_id;e&&s==this.config.sessionId&&r==this.userId&&this.ws.sendMessage(JSON.stringify(t({pb_msg:{user_id:this.userId,session_type:1,session_id:this.config.sessionId,msg_id_begin:e,msg_cnt:this.messageCount}},this.prepareCommonParams(m.MESSAGE,E.HISTORYMSG))))}},e.prototype.getHistoryMsgRes=function(t){var i=t.pb_msg;if(i){var n=i.msg_list,e=i.result_code,s=i.session_id,r=i.user_id;0==e&&s==this.config.sessionId&&r==this.userId&&N.push(n)}},e.prototype.changeKefuRes=function(t){return i(this,void 0,void 0,(function(){var i,e;return n(this,(function(n){return(i=t.pb_msg)&&0==i.result_code?(null!=(e=i.new_kefu_id)&&this.updateSessionId(e),[2]):[2]}))}))},e.prototype.updateSessionId=function(t){return i(this,void 0,void 0,(function(){var i=this;return n(this,(function(n){switch(n.label){case 0:return this.config.sessionId=t,[4,k.push({sessionId:t})];case 1:return n.sent(),setTimeout((function(){i.updateHistory()}),0),[2]}}))}))},e}(),H=function(){function t(t){this.key="IMMH".concat(t)}return t.prototype.add=function(t){var i=this.get();i?(i.push(t),i=this.handleOversize(i),this.setCookie(JSON.stringify(i))):this.setCookie(JSON.stringify([t]))},t.prototype.set=function(t){var i=this.handleOversize(t);this.setCookie(JSON.stringify(i))},t.prototype.get=function(){var t,i="; ".concat(document.cookie).split("; ".concat(this.key,"="));if(2===i.length)try{var n=null===(t=i.pop())||void 0===t?void 0:t.split(";").shift();return n?JSON.parse(n):null}catch(t){return null}return null},t.prototype.setCookie=function(t){document.cookie="".concat(this.key,"=").concat(t,"; domain=").concat(this.getRootDomain(),"; max-age=").concat(604800,"; path=/; SameSite=None; Secure")},t.prototype.handleOversize=function(t){var i=t;return new Blob([JSON.stringify(i)]).size>4096?(i.shift(),this.handleOversize(i)):i},t.prototype.getRootDomain=function(){var t=window.location.hostname,i=t.split(".");return i.length>2?i.slice(-2).join("."):t},t}(),G=function(){function t(t){this.appId=t}return t.prototype.getUserInfo=function(t,e){return i(this,void 0,void 0,(function(){var i,s,r;return n(this,(function(n){switch(n.label){case 0:return[4,a("f2ea43ef1e6f67f2d1c23f4a7f2317d8".concat(JSON.stringify(t)))];case 1:i=n.sent(),s=0,n.label=2;case 2:return s<3?[4,fetch("".concat(e).concat(i),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({App_id:this.appId,UserID_List:t})})]:[3,6];case 3:return(r=n.sent()).ok?[4,r.json()]:[3,5];case 4:return[2,n.sent()];case 5:return s++,[3,2];case 6:return[2]}}))}))},t}();!function(t){t[t.time=1]="time",t[t.message=2]="message",t[t.isMe=3]="isMe",t[t.id=4]="id"}(P||(P={}));var U=function(){function e(){this.currentLatestMessageTime=0,this.currentLatestMessageDate="",this.inited=!1,this.isRTCInserted=!1,this.defaultMsg="Good day, nice to serve you~"}return e.prototype.updateConfig=function(i){var n=i.pid,e=i.defaultOpen,s=i.extraInfo,r=i.cid,o=g();null!=n&&(this.config.pid=+n),null!=e&&(this.config.defaultOpen=e),this.config.extraInfo=s||"{}";try{var u=JSON.parse(s);this.config.extraInfo=JSON.stringify(t(t({},u),{os:o.osName,browser:o.bsName,browser_version:o.bsVersion,isMobile:o.isMobile}))}catch(t){}this.controller.updateConfig({pid:n,extraInfo:s,cid:r}),this.config.defaultOpen&&this.openChat()},e.prototype.init=function(e){var s=this;if(this.inited)this.updateConfig(t(t({},this.config),e));else{this.config=e,this.config.activeId&&this.config.loginName&&this.config.appId&&this.config.wsURL&&this.config.userInfoURL&&this.config.fileServer||console.error("Init IM error. Please check the config."),this.defaultMsg=e.defaultMessage||this.defaultMsg;var o=g();try{var u=JSON.parse(this.config.extraInfo||"{}");this.config.extraInfo=JSON.stringify(t(t({},u),{os:o.osName,browser:o.bsName,browser_version:o.bsVersion,isMobile:o.isMobile}))}catch(t){}for(var a=document.getElementsByTagName("script"),l=0;l<a.length;l++){var m=a[l].src;if(m.includes("imlite")){(m=m.split("/")).pop(),this.config.pathToIM=m.join("/");break}}this.defaultAvatarImg="".concat(this.config.pathToIM,"/assets/E-sprite.png"),this.defaultMp3="".concat(this.config.pathToIM,"/assets/E-im-msg.mp3"),this.api=new G(this.config.appId);var E=h("div");E.classList.add("-E-im-container"),E.innerHTML='<button class="-E-im-tigger"><div class="-E-tigger -E-sprite"></div></button><div class="-E-im -E-h"><div class="-E-pop -E-h"></div><audio class="-E-audio"></audio><ul class="-E-toast"></ul><div class="-E-header"><div class="-E-user-info"><div class="-E-avatar"><img class="-E-default"></div><span class="-E-name"></span></div><div class="-E-actions"><button class="-E-minus"><span class="-E-minus-icon"></span></button></div></div><ul class="-E-main"></ul><div class="-E-footer"><div class="-E-hint -E-h"><span class="-E-typing"></span> is typing</div><input type="file" multiple class="-E-uploader" accept="image/*"><div class="-E-file-popover -E-h"><ul><li class="-E-upload-li"><div class="-E-sprite -E-image"></div> Photo</li><li class="-E-video-li"><div class="-E-sprite -E-video"></div> Video Call</li><li class="-E-audio-li"><div class="-E-sprite -E-audio"></div> Audio Call</li></ul></div><button class="-E-add-file"><div class="-E-sprite -E-add"></div></button><div class="-E-input-container"><textarea class="-E-input" rows="1" placeholder="Type a message" maxlength="1500"></textarea></div><button class="-E-send-message"><div class="-E-sprite -E-send"></div></button></div></div>',v(document.body,E);var w=c(".-E-im-tigger"),p=c(".-E-im"),S=c(".-E-minus",p),b=c(".-E-input",p),y=c(".-E-send-message",p),T=c(".-E-avatar img",p),M=c(".-E-add-file",p),O=c(".-E-upload-li",p),_=c(".-E-uploader",p),D=c(".-E-pop",p),N=c(".-E-audio-li",p),k=c(".-E-video-li",p),x=c(".-E-main",p);w&&p&&S&&b&&y&&T&&M&&O&&_&&D&&N&&k&&x?(f("click",(function(){s.openChat()}),w),f("click",(function(){s.closeChat()}),S),f("input",(function(){r(b)}),b),f("click",(function(){var t=c(".-E-file-popover",p);t&&t.classList.toggle("-E-h")}),M),f("click",(function(){s.hideFilePopover(),_.click()}),O),f("change",(function(t){return i(s,void 0,void 0,(function(){var i;return n(this,(function(n){switch(n.label){case 0:return i=t.currentTarget,[4,this.sendFiles(i.files)];case 1:return n.sent(),[2]}}))}))}),_),f("wheel",(function(t){var i=t.currentTarget,n=i.scrollTop,e=i.scrollHeight,s=i.offsetHeight;(t.deltaY<0&&0===n||t.deltaY>0&&n+s>=e)&&t.preventDefault()}),x),f("keydown",(function(t){var i=13===t.keyCode,n=t.altKey,e=t.shiftKey,o=t.ctrlKey||t.metaKey;if(i&&(o||n||e)){var u=t.currentTarget;u.value+="\n",r(u),u.scrollTo({top:u.scrollHeight,behavior:"auto"})}i&&(s.sendMessage(b),t.stopPropagation(),t.preventDefault())}),b),f("click",(function(){s.sendMessage(b)}),y),f("click",(function(){return i(s,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,this.insertRTC()];case 1:return t.sent(),[4,this.controller.connect()];case 2:return t.sent(),window.IMRTC.openAudio(N),this.hideFilePopover(),[2]}}))}))}),N),f("click",(function(){return i(s,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,this.insertRTC()];case 1:return t.sent(),[4,this.controller.connect()];case 2:return t.sent(),window.IMRTC.openVideo(k),this.hideFilePopover(),[2]}}))}))}),k),f("click",(function(){D.innerHTML="",D.classList.add("-E-h")}),D),f("error",this.handleAvatarError(T),T,!0),this.toast=new I(c(".-E-im .-E-toast")),this.initUserInfo(),this.listenSentMessage(),this.listenResMessage(),this.messageManagar=new H(this.config.activeId),this.controller=new J({wsConfig:{url:this.config.wsURL},appId:this.config.appId,loginName:this.config.loginName,sessionId:this.config.activeId,extraInfo:this.config.extraInfo,pid:+this.config.pid,cid:+this.config.cid}),this.initLocalHistory(),f("focus",(function(){s.controller.connect();var t=0,i=function(i){t=i.targetTouches[0].pageY},n=function(i){0!==t-i.targetTouches[0].pageY&&b.blur()},e=function(){d("touchstart",i),d("touchmove",n),d("touchend",e)};f("touchstart",i),f("touchmove",n),f("touchend",e)}),b),f("paste",(function(t){var i;s.sendFiles(null===(i=t.clipboardData)||void 0===i?void 0:i.files)}),b),this.listenHistory(),this.setAvatar(T,this.defaultAvatarImg),this.config.defaultOpen&&this.openChat(),this.listenSessionUpdate(),this.inited=!0):console.error("Init IM error.")}},e.prototype.loadHistory=function(t,i){if(i){var n=c(".-E-main");n&&(n.innerHTML="")}for(var e=0,s=t;e<s.length;e++){var r=s[e];c(".-E-main li.-E-message-".concat(r[P.id]))||this.appendMessage(r[P.message],r[P.time],r[P.isMe]?"s":"r",!1,!1,r[P.id])}var o=t[t.length-1];-1!=o[P.id]&&(Math.floor((new Date).getTime()/1e3)-o[P.time]<600&&this.controller.connect())},e.prototype.sendFiles=function(t){return i(this,void 0,void 0,(function(){var i,e,s,r,o,a,c,h,f,d,v,l;return n(this,(function(m){switch(m.label){case 0:if(!t)return[2];i=[],e=[".php",".jsp"," .asp",".aspx",".js",".sh",".py",".pl",".out",".bin",".run",".jar",".class"],s=function(t){var s,o,a,c,h,f,d,v;return n(this,(function(n){switch(n.label){case 0:return s=t.name,o=t.type,a=t.size,e.find((function(t){return s.toLowerCase().indexOf(t)>-1}))?(r.toast.error("File: ".concat(s," is not allowed.")),[2,{value:void 0}]):["image/gif","image/jpeg","image/png","image/bmp","image/jpg","image/webp"].find((function(t){return t.toLowerCase()==o.toLowerCase()}))?a>52428800?(r.toast.error("Please upload a image within 50MB."),[2,{value:void 0}]):(c=Math.floor((new Date).getTime()/1e3),f=(h=i).push,v=(d=r).appendMessage,[4,u(t)]):(r.toast.error("File: ".concat(s," is not allowed.")),[2,{value:void 0}]);case 1:return f.apply(h,[v.apply(d,[n.sent(),c,"s",!0,!0])||""]),[2]}}))},r=this,o=0,a=t,m.label=1;case 1:return o<a.length?(v=a[o],[5,s(v)]):[3,4];case 2:if("object"==typeof(c=m.sent()))return[2,c.value];m.label=3;case 3:return o++,[3,1];case 4:h=0,f=0,d=t,m.label=5;case 5:return f<d.length?(v=d[f],i[h]?[4,this.uploadFile(v)]:[2]):[3,9];case 6:return(l=m.sent())?[4,this.controller.sendMessage("&$#@~^@[{:".concat(l,":}]&$~@#@"),i[h])]:[2];case 7:m.sent(),h++,m.label=8;case 8:return f++,[3,5];case 9:return[2]}}))}))},e.prototype.hideFilePopover=function(){var t=c(".-E-im .-E-file-popover");t&&t.classList.add("-E-h")},e.prototype.initUserInfo=function(){return i(this,void 0,void 0,(function(){var t,i,e,s,r,o,u;return n(this,(function(n){switch(n.label){case 0:return[4,this.api.getUserInfo([this.config.activeId],this.config.userInfoURL)];case 1:return(t=n.sent())?(0==t.error_code&&(i=(null===(r=t.user_info_list[0])||void 0===r?void 0:r.nick)||(null===(o=t.user_info_list[0])||void 0===o?void 0:o.user_name),e=null===(u=t.user_info_list[0])||void 0===u?void 0:u.avatar_url,(s=c(".-E-im .-E-avatar img"))&&this.setAvatar(s,e),this.setName(i),this.userInfo={name:i,avatar:e}),[2]):(this.toast.error("Faild to get user info."),[2])}}))}))},e.prototype.setName=function(t){var i=c(".-E-im .-E-name");if(i){i.textContent=t,i.setAttribute("title",t);var n=c(".-E-im .-E-typing");n&&(n.textContent=t)}},e.prototype.setAvatar=function(t,i){var n=this,e=function(t){var i=t.currentTarget;i.getAttribute("src")==n.defaultAvatarImg?i.classList.replace("-E-not-default","-E-default"):i.classList.replace("-E-default","-E-not-default")},s=i;s!=this.defaultAvatarImg?(null!=this.config.replaceAvatarURL&&s&&(s="".concat(this.config.replaceAvatarURL).concat(btoa(i))),t&&(t.src=s||"",d("load",e,t),f("load",e,t))):t.src=s},e.prototype.palyMsgAudio=function(){var t=c(".-E-im .-E-audio");t&&(t.getAttribute("src")||(t.src=this.defaultMp3),t.play())},e.prototype.insertTime=function(t){var i=c(".-E-im .-E-main");if(t&&i){var n=h("li");n.classList.add("-E-time-item");var e=h("span");e.classList.add("-E-time"),e.textContent=t,v(n,e),v(i,n)}},e.prototype.sendMessage=function(t){return i(this,void 0,void 0,(function(){var i,e,s;return n(this,(function(n){return i=t.value.trim(),c(".-E-im .-E-main")&&i?(t.value="",t.focus(),t.setAttribute("style","height:auto"),e=Math.floor((new Date).getTime()/1e3),(s=this.appendMessage(i,e,"s",!0))?(this.controller.sendMessage(i,s),[2]):[2]):(t.focus(),[2])}))}))},e.prototype.isImageMessage=function(t){var i=t.match(/&\$#@~\^@\[\{:(.*):\}\]&\$~@#@/i);return!(!i||2!=i.length)&&i[1]},e.prototype.isFileMessage=function(t){try{var i=JSON.parse(t),n=i.subType,e=i.content,s=e.url,r=e.name;if(4==n&&null!=s&&null!=r)return{url:s,name:r}}catch(t){return!1}},e.prototype.appendMessage=function(t,i,n,e,s,r){var u=null,a=c(".-E-im .-E-main");if(a){var d=new Date(1e3*i).toLocaleDateString(),m=(new Date).toLocaleDateString()==d;(this.currentLatestMessageDate!=d&&!m||i-this.currentLatestMessageTime>300&&m)&&(this.insertTime(function(t){var i=new Date(10===t.toString().length?1e3*t:t),n=new Date;if(i.toDateString()==n.toDateString())return o(i,"HHmm");var e=new Date(n);if(e.setDate(n.getDate()-1),e.toDateString()==i.toDateString())return"Yesterday ".concat(o(i,"HHmm"));var s=function(t){var i=t.getDay(),n=t.getDate()-i+(0===i?-6:1);return new Date(t.setDate(n))},r=s(new Date(n)),u=s(new Date(i));if(r.toDateString()==u.toDateString()){var a=o(i,"dddd").split(" ")[0];return"".concat(a," ").concat(o(i,"HHmm"))}return n.getFullYear()==i.getFullYear()?o(i,"MMDD"):o(i,"YYYMMDD")}(i)),this.currentLatestMessageDate=d,this.currentLatestMessageTime=i);var E=h("li");null!=r&&E.classList.add("-E-message-".concat(r));var w=h("div");w.classList="-E-message -E-message-".concat(n);var p=this.isImageMessage(t);if(s||p){p&&(t=p);var g=h("img");g.src=t,v(w,g),w.classList.add("-E-message-img"),f("click",(function(){var i=c(".-E-pop");if(i){var n=h("img");n.src=t,v(i,n),i.classList.remove("-E-h")}}),w)}else{var S=this.isFileMessage(t);if(S){var b=S.url,y=S.name,T=h("a");T.href=b,T.textContent=y,T.title=y,T.setAttribute("download",y),v(w,T),w.classList.add("-E-message-link")}else{var M=h("pre");M.textContent=t,v(w,M)}}if("s"==n&&e){var O=h("i");O.classList.add("-E-loading-icon"),E.append(O),u=l(),E.id=u}return v(E,w),E.classList.add("-E-message-item-".concat(n)),v(a,E),this.goToBottom(),u}},e.prototype.goToBottom=function(){setTimeout((function(){var t=c(".-E-im .-E-main");t&&t.scrollTo({top:t.scrollHeight,behavior:"smooth"})}),100)},e.prototype.markSendError=function(t){var i=h("div");i.classList="-E-send-error -E-sprite",this.markSent(t);var n=c("#".concat(t)),e=c(".-E-message",n);n&&e&&n.insertBefore(i,e)},e.prototype.markSent=function(t,i){var n,e=c("#".concat(t));null===(n=c(".-E-loading-icon",e))||void 0===n||n.remove(),i&&(null==e||e.classList.add("-E-message-".concat(i)))},e.prototype.toggleHint=function(t){var i=c(".-E-im .-E-hint");t?null==i||i.classList.remove("-E-h"):null==i||i.classList.add("-E-h")},e.prototype.listenSentMessage=function(){return i(this,void 0,void 0,(function(){var t,i,e,r,o,u,a,c,h,f,d=this;return n(this,(function(n){switch(n.label){case 0:n.trys.push([0,5,6,11]),t=!0,i=s(O),n.label=1;case 1:return[4,i.next()];case 2:if(e=n.sent(),a=e.done)return[3,4];f=e.value,t=!1,"fail"==(r=f).status?this.markSendError(r.uuid):"success"==r.status&&(this.markSent(r.uuid,r.messageId),this.messageManagar.add(((u={})[P.time]=Math.floor((new Date).getTime()/1e3),u[P.message]=r.message,u[P.isMe]=1,u[P.id]=r.messageId,u)),this.toggleHint(!0),this.hintTimeout&&(clearTimeout(this.hintTimeout),this.hintTimeout=void 0),this.hintTimeout=setTimeout((function(){d.toggleHint(!1)}),3e3)),n.label=3;case 3:return t=!0,[3,1];case 4:return[3,11];case 5:return o=n.sent(),c={error:o},[3,11];case 6:return n.trys.push([6,,9,10]),t||a||!(h=i.return)?[3,8]:[4,h.call(i)];case 7:n.sent(),n.label=8;case 8:return[3,10];case 9:if(c)throw c.error;return[7];case 10:return[7];case 11:return[2]}}))}))},e.prototype.listenResMessage=function(){return i(this,void 0,void 0,(function(){var t,i,e,r,o,u,a,c,h,f;return n(this,(function(n){switch(n.label){case 0:n.trys.push([0,5,6,11]),t=!0,i=s(_),n.label=1;case 1:return[4,i.next()];case 2:if(e=n.sent(),a=e.done)return[3,4];f=e.value,t=!1,r=f,this.messageManagar.add(((u={})[P.time]=r.time,u[P.message]=r.message,u[P.isMe]=0,u[P.id]=r.messageId,u)),this.palyMsgAudio(),this.appendMessage(r.message,r.time,"r",!1,!1,r.messageId),this.openChat(),n.label=3;case 3:return t=!0,[3,1];case 4:return[3,11];case 5:return o=n.sent(),c={error:o},[3,11];case 6:return n.trys.push([6,,9,10]),t||a||!(h=i.return)?[3,8]:[4,h.call(i)];case 7:n.sent(),n.label=8;case 8:return[3,10];case 9:if(c)throw c.error;return[7];case 10:return[7];case 11:return[2]}}))}))},e.prototype.uploadFile=function(t){return i(this,void 0,void 0,(function(){var i,e,s,r;return n(this,(function(n){switch(n.label){case 0:return[4,a(t)];case 1:return i=n.sent(),(e=new FormData).append("uploadFile",t),e.append("md5",i),e.append("src","echatLite_v3"),e.append("alg","sha256"),[4,fetch(this.config.fileServer,{method:"POST",body:e})];case 2:return(s=n.sent()).ok?[4,s.json()]:(this.toast.error("Upload file failed"),[2]);case 3:return 0===(r=n.sent()).code?[2,r.url]:(this.toast.error("Upload file failed:"+JSON.stringify(r.msg)),[2])}}))}))},e.prototype.listenHistory=function(){return i(this,void 0,void 0,(function(){var t,i,e,r,o,u,a,c,h,f,d=this;return n(this,(function(n){switch(n.label){case 0:n.trys.push([0,5,6,11]),t=!0,i=s(N),n.label=1;case 1:return[4,i.next()];case 2:if(e=n.sent(),a=e.done)return[3,4];f=e.value,t=!1,r=f.map((function(t){var i,n=t.create_time,e=t.msg_data,s=t.msg_id,r=t.from_session_id;return(i={})[P.time]=n,i[P.message]=e,i[P.isMe]=r==d.config.activeId?0:1,i[P.id]=s,i})),o=r.sort((function(t,i){return t[P.id]-i[P.id]})),this.messageManagar.set(o),this.loadHistory(o),n.label=3;case 3:return t=!0,[3,1];case 4:return[3,11];case 5:return u=n.sent(),c={error:u},[3,11];case 6:return n.trys.push([6,,9,10]),t||a||!(h=i.return)?[3,8]:[4,h.call(i)];case 7:n.sent(),n.label=8;case 8:return[3,10];case 9:if(c)throw c.error;return[7];case 10:return[7];case 11:return[2]}}))}))},e.prototype.openChat=function(){var t=c(".-E-im-tigger"),i=c(".-E-im");(null==t?void 0:t.classList.contains("-E-h"))||(null==t||t.classList.add("-E-h"),null==i||i.classList.remove("-E-h"),this.goToBottom())},e.prototype.closeChat=function(){var t=c(".-E-im-tigger"),i=c(".-E-im"),n=c(".-E-file-popover",i);null==n||n.classList.add("-E-h"),null==t||t.classList.remove("-E-h"),null==i||i.classList.add("-E-h"),this.controller.handleClickHideSessionEffect()},e.prototype.listenSessionUpdate=function(){return i(this,void 0,void 0,(function(){var t,i,e,r,o,u,a,c,h;return n(this,(function(n){switch(n.label){case 0:n.trys.push([0,5,6,11]),t=!0,i=s(k),n.label=1;case 1:return[4,i.next()];case 2:if(e=n.sent(),u=e.done)return[3,4];h=e.value,t=!1,r=h,this.config.activeId=r.sessionId,this.messageManagar=new H(this.config.activeId),this.initUserInfo(),this.initLocalHistory(),n.label=3;case 3:return t=!0,[3,1];case 4:return[3,11];case 5:return o=n.sent(),a={error:o},[3,11];case 6:return n.trys.push([6,,9,10]),t||u||!(c=i.return)?[3,8]:[4,c.call(i)];case 7:n.sent(),n.label=8;case 8:return[3,10];case 9:if(a)throw a.error;return[7];case 10:return[7];case 11:return[2]}}))}))},e.prototype.initLocalHistory=function(){var t,i=this.messageManagar.get();i&&i.length||(i=[(t={},t[P.message]=this.defaultMsg,t[P.id]=-1,t[P.time]=(new Date).getTime(),t[P.isMe]=0,t)]),this.loadHistory(i,!0)},e.prototype.insertRTC=function(){return i(this,void 0,void 0,(function(){var t=this;return n(this,(function(i){switch(i.label){case 0:return this.isRTCInserted?[2]:(this.isRTCInserted=!0,[4,new Promise((function(i){var n=h("script");if(n){n.src="".concat(t.config.pathToIM,"/imlite.rtc.v1.js"),f("load",i,n);var e=c("head");e&&v(e,n)}}))]);case 1:return i.sent(),[4,window.IMRTC.init()];case 2:return i.sent(),[2]}}))}))},e.prototype.handleAvatarError=function(t){var i=this,n=0;return function(){var e=t.getAttribute("src");e?e!=i.defaultAvatarImg?++n>3?i.setAvatar(t,i.defaultAvatarImg):setTimeout((function(){i.setAvatar(t,e)}),2e3):n=0:i.setAvatar(t,i.defaultAvatarImg)}},e}();window.IM=new U}();
